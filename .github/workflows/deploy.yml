name: ğŸš€ è‡ªå‹•éƒ¨ç½² QWV VPN

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ä¼ºæœå™¨
    runs-on: ubuntu-latest
    
    # åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æ™‚åŸ·è¡Œéƒ¨ç½²ï¼ˆä¸åœ¨ PR æ™‚éƒ¨ç½²ï¼‰
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ”§ è¨­å®š SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPN_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        # è¨­å®š SSH é…ç½®ï¼Œé¿å…ä¸»æ©Ÿé‡‘é‘°æª¢æŸ¥
        cat >> ~/.ssh/config << EOF
        Host ${{ secrets.VPN_HOST }}
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
        EOF
        # å¦‚æœéœ€è¦è‡ªè¨‚é€£æ¥åŸ ï¼Œå¾ secrets è®€å–
        VPN_PORT="${{ secrets.VPN_PORT }}"
        if [ -n "$VPN_PORT" ] && [ "$VPN_PORT" != "22" ]; then
          ssh-keyscan -p $VPN_PORT -H ${{ secrets.VPN_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        else
          ssh-keyscan -H ${{ secrets.VPN_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        fi
        
    - name: ğŸ” é©—è­‰é€£ç·š
      run: |
        # æ”¯æ´è‡ªè¨‚ SSH é€£æ¥åŸ 
        VPN_PORT="${{ secrets.VPN_PORT }}"
        SSH_OPTIONS="-o ConnectTimeout=10 -o StrictHostKeyChecking=no"
        if [ -n "$VPN_PORT" ] && [ "$VPN_PORT" != "22" ]; then
          SSH_OPTIONS="$SSH_OPTIONS -p $VPN_PORT"
        fi
        ssh $SSH_OPTIONS ${{ secrets.VPN_USER }}@${{ secrets.VPN_HOST }} "echo 'âœ… SSH é€£ç·šæˆåŠŸ'"
        
    - name: ğŸ“‹ æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹
      run: |
        VPN_PORT="${{ secrets.VPN_PORT }}"
        SSH_OPTIONS="-o ConnectTimeout=10 -o StrictHostKeyChecking=no"
        if [ -n "$VPN_PORT" ] && [ "$VPN_PORT" != "22" ]; then
          SSH_OPTIONS="$SSH_OPTIONS -p $VPN_PORT"
        fi
        ssh $SSH_OPTIONS ${{ secrets.VPN_USER }}@${{ secrets.VPN_HOST }} "
          echo 'ğŸ” æª¢æŸ¥ Docker ç‹€æ…‹:'
          docker --version
          echo 'ğŸ“Š æª¢æŸ¥ç›®å‰é‹è¡Œçš„å®¹å™¨:'
          docker ps || true
          echo 'ğŸ’½ æª¢æŸ¥ç£ç¢Ÿç©ºé–“:'
          df -h / || true
          echo 'ğŸ’¾ æª¢æŸ¥è¨˜æ†¶é«”ä½¿ç”¨:'
          free -h || true
        "
        
    - name: ğŸ”„ éƒ¨ç½²åˆ°ä¼ºæœå™¨
      run: |
        VPN_PORT="${{ secrets.VPN_PORT }}"
        SSH_OPTIONS="-o ConnectTimeout=10 -o StrictHostKeyChecking=no"
        if [ -n "$VPN_PORT" ] && [ "$VPN_PORT" != "22" ]; then
          SSH_OPTIONS="$SSH_OPTIONS -p $VPN_PORT"
        fi
        ssh $SSH_OPTIONS ${{ secrets.VPN_USER }}@${{ secrets.VPN_HOST }} "
          set -e  # ç™¼ç”ŸéŒ¯èª¤ç«‹å³é€€å‡º
          
          echo 'ğŸ“‚ åˆ‡æ›åˆ°éƒ¨ç½²ç›®éŒ„...'
          cd ${{ secrets.VPN_DEPLOY_PATH }}
          
          echo 'ğŸ“¥ æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼...'
          git fetch origin || { echo 'âŒ Git fetch å¤±æ•—'; exit 1; }
          git reset --hard origin/main || { echo 'âŒ Git reset å¤±æ•—'; exit 1; }
          
          echo 'ğŸ›‘ åœæ­¢ç¾æœ‰æœå‹™...'
          ./scripts/manage.sh stop || echo 'âš ï¸ åœæ­¢æœå‹™æ™‚å‡ºç¾è­¦å‘Šï¼ˆå¯èƒ½æœå‹™æœªé‹è¡Œï¼‰'
          
          echo 'ğŸ“¦ æ‹‰å–æœ€æ–°æ˜ åƒæª”...'
          docker compose pull || { echo 'âŒ Docker compose pull å¤±æ•—'; exit 1; }
          
          echo 'ğŸ”§ è¨­å®šç’°å¢ƒè®Šæ•¸...'
          cat > .env << 'EOF'
        CF_API_TOKEN=${{ secrets.CF_API_TOKEN }}
        CF_ZONE=${{ secrets.CF_ZONE }}
        CF_SUBDOMAIN=${{ secrets.CF_SUBDOMAIN }}
        EOF
          
          echo 'âœ… ç’°å¢ƒè®Šæ•¸è¨­å®šå®Œæˆ'
          
          echo 'ğŸš€ å•Ÿå‹•æœå‹™...'
          ./scripts/manage.sh start || { echo 'âŒ å•Ÿå‹•æœå‹™å¤±æ•—'; exit 1; }
          
          echo 'â³ ç­‰å¾…æœå‹™å®Œå…¨å•Ÿå‹•...'
          sleep 15
          
          echo 'ğŸ“Š æª¢æŸ¥æœå‹™ç‹€æ…‹:'
          ./scripts/manage.sh status || { echo 'âŒ ç„¡æ³•å–å¾—æœå‹™ç‹€æ…‹'; exit 1; }
          
          echo 'ğŸ” æª¢æŸ¥ WireGuard ç‹€æ…‹:'
          ./scripts/manage.sh peers || echo 'âš ï¸ æš«ç„¡å®¢æˆ¶ç«¯é€£æ¥'
        "
        
    - name: ğŸ§¹ æ¸…ç†æ˜ åƒæª”
      run: |
        VPN_PORT="${{ secrets.VPN_PORT }}"
        SSH_OPTIONS="-o ConnectTimeout=10 -o StrictHostKeyChecking=no"
        if [ -n "$VPN_PORT" ] && [ "$VPN_PORT" != "22" ]; then
          SSH_OPTIONS="$SSH_OPTIONS -p $VPN_PORT"
        fi
        ssh $SSH_OPTIONS ${{ secrets.VPN_USER }}@${{ secrets.VPN_HOST }} "
          echo 'ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„ Docker æ˜ åƒæª”...'
          docker image prune -f || echo 'âš ï¸ æ˜ åƒæª”æ¸…ç†æ™‚å‡ºç¾è­¦å‘Š'
          
          echo 'ğŸ—‘ï¸ æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨...'
          docker container prune -f || echo 'âš ï¸ å®¹å™¨æ¸…ç†æ™‚å‡ºç¾è­¦å‘Š'
          
          echo 'ğŸ’¾ æª¢æŸ¥æ¸…ç†å¾Œçš„ç£ç¢Ÿç©ºé–“:'
          df -h / || true
        "
        
    - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸ‰ VPN æœå‹™å·²æˆåŠŸéƒ¨ç½²åˆ°ä¼ºæœå™¨ï¼"
        echo "ğŸ“ ä¼ºæœå™¨: ${{ secrets.VPN_HOST }}"
        echo "ğŸŒ VPN åŸŸå: ${{ secrets.CF_SUBDOMAIN }}.${{ secrets.CF_ZONE }}"
        echo "ğŸ”Œ VPN é€£æ¥åŸ : 51820"
        echo "â° éƒ¨ç½²æ™‚é–“: $(date)"
        echo ""
        echo "ğŸ”— ä¸‹ä¸€æ­¥: ç™»å…¥ä¼ºæœå™¨åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ä¾†ç²å–å®¢æˆ¶ç«¯è¨­å®šï¼š"
        echo "   ./scripts/manage.sh qr <å®¢æˆ¶ç«¯åç¨±>"
        
    - name: ğŸš¨ éƒ¨ç½²å¤±æ•—å›æ»¾
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±æ•—ï¼Œå˜—è©¦å›æ»¾æœå‹™..."
        VPN_PORT="${{ secrets.VPN_PORT }}"
        SSH_OPTIONS="-o ConnectTimeout=10 -o StrictHostKeyChecking=no"
        if [ -n "$VPN_PORT" ] && [ "$VPN_PORT" != "22" ]; then
          SSH_OPTIONS="$SSH_OPTIONS -p $VPN_PORT"
        fi
        ssh $SSH_OPTIONS ${{ secrets.VPN_USER }}@${{ secrets.VPN_HOST }} "
          cd ${{ secrets.VPN_DEPLOY_PATH }}
          echo 'ğŸ”„ å˜—è©¦é‡æ–°å•Ÿå‹•æœå‹™...'
          ./scripts/manage.sh restart || echo 'âŒ ç„¡æ³•é‡æ–°å•Ÿå‹•æœå‹™'
          echo 'ğŸ“Š æª¢æŸ¥æœå‹™ç‹€æ…‹:'
          ./scripts/manage.sh status || echo 'âŒ æœå‹™ç•°å¸¸'
        " || echo "âŒ ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨é€²è¡Œå›æ»¾"
        
  validate:
    name: é©—è­‰é…ç½®
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ”§ å®‰è£é©—è­‰å·¥å…·
      run: |
        # å®‰è£ shellcheck ç”¨æ–¼è…³æœ¬æª¢æŸ¥
        sudo apt-get update
        sudo apt-get install -y shellcheck
        
    - name: ğŸ” åŸ·è¡Œå°ˆæ¡ˆå®Œæ•´é©—è­‰
      run: |
        # çµ¦è…³æœ¬åŸ·è¡Œæ¬Šé™
        chmod +x scripts/*.sh
        
        # åŸ·è¡Œå®Œæ•´å°ˆæ¡ˆé©—è­‰
        ./scripts/validate.sh 