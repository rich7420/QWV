name: ðŸš€ è‡ªå‹•éƒ¨ç½² QWV VPN

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    name: éƒ¨ç½²åˆ°ä¼ºæœå™¨
    runs-on: ubuntu-latest
    
    # åªåœ¨æŽ¨é€åˆ° main åˆ†æ”¯æ™‚åŸ·è¡Œéƒ¨ç½²ï¼ˆä¸åœ¨ PR æ™‚éƒ¨ç½²ï¼‰
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ðŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: ðŸ”§ è¨­å®š SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPN_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPN_HOST }} >> ~/.ssh/known_hosts
        
    - name: ðŸ” é©—è­‰é€£ç·š
      run: |
        ssh -o ConnectTimeout=10 ${{ secrets.VPN_USER }}@${{ secrets.VPN_HOST }} "echo 'é€£ç·šæˆåŠŸ'"
        
    - name: ðŸ“‹ æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹
      run: |
        ssh ${{ secrets.VPN_USER }}@${{ secrets.VPN_HOST }} "
          echo 'æª¢æŸ¥ Docker ç‹€æ…‹:'
          docker --version
          echo 'æª¢æŸ¥ç›®å‰é‹è¡Œçš„å®¹å™¨:'
          docker ps || true
        "
        
    - name: ðŸ”„ éƒ¨ç½²åˆ°ä¼ºæœå™¨
      run: |
        ssh ${{ secrets.VPN_USER }}@${{ secrets.VPN_HOST }} "
          cd ${{ secrets.VPN_DEPLOY_PATH }}
          
          echo 'ðŸ“¥ æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼...'
          git fetch origin
          git reset --hard origin/main
          
          echo 'ðŸ›‘ åœæ­¢ç¾æœ‰æœå‹™...'
          ./scripts/manage.sh stop || true
          
          echo 'ðŸ“¦ æ‹‰å–æœ€æ–°æ˜ åƒæª”...'
          docker compose pull
          
          echo 'ðŸ”§ è¨­å®šç’°å¢ƒè®Šæ•¸...'
          cat > .env << EOF
        CF_API_TOKEN=${{ secrets.CF_API_TOKEN }}
        CF_ZONE=${{ secrets.CF_ZONE }}
        CF_SUBDOMAIN=${{ secrets.CF_SUBDOMAIN }}
        EOF
          
          echo 'ðŸš€ å•Ÿå‹•æœå‹™...'
          ./scripts/manage.sh start
          
          echo 'âœ… éƒ¨ç½²å®Œæˆï¼Œç­‰å¾…æœå‹™å•Ÿå‹•...'
          sleep 10
          
          echo 'ðŸ“Š æª¢æŸ¥æœå‹™ç‹€æ…‹:'
          ./scripts/manage.sh status
        "
        
    - name: ðŸ§¹ æ¸…ç†æ˜ åƒæª”
      run: |
        ssh ${{ secrets.VPN_USER }}@${{ secrets.VPN_HOST }} "
          echo 'ðŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„æ˜ åƒæª”...'
          docker image prune -f || true
        "
        
    - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "ðŸŽ‰ VPN æœå‹™å·²æˆåŠŸéƒ¨ç½²åˆ°ä¼ºæœå™¨ï¼"
        echo "ä¼ºæœå™¨: ${{ secrets.VPN_HOST }}"
        echo "åŸŸå: ${{ secrets.CF_SUBDOMAIN }}.${{ secrets.CF_ZONE }}"
        
  validate:
    name: é©—è­‰é…ç½®
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: ðŸ” é©—è­‰ Docker Compose èªžæ³•
      run: |
        # æª¢æŸ¥ docker-compose.yml èªžæ³•
        docker compose config
        
    - name: ðŸ” é©—è­‰è…³æœ¬èªžæ³•
      run: |
        # ä½¿ç”¨ shellcheck æª¢æŸ¥è…³æœ¬
        sudo apt-get update
        sudo apt-get install -y shellcheck
        shellcheck scripts/*.sh
        
    - name: ðŸ“‹ é©—è­‰ç¯„æœ¬æª”æ¡ˆ
      run: |
        # æª¢æŸ¥å¿…è¦æª”æ¡ˆæ˜¯å¦å­˜åœ¨
        test -f docker-compose.yml
        test -f env.example
        test -f scripts/setup.sh
        test -f scripts/manage.sh
        test -f README.md
        echo "âœ… æ‰€æœ‰å¿…è¦æª”æ¡ˆéƒ½å­˜åœ¨" 